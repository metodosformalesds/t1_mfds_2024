{% extends "base.html" %}

{% block content %}
<div class="container mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Regresar -->
    <a href="{% url 'listar_chats' %}" class="flex items-center text-black pb-4">
        <svg class="mr-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M10.854 4.146a.5.5 0 0 1 0 .708L7.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0z"/>
        </svg>
        Regresar
    </a>

    <!-- Título del chat -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
        {% if es_soporte %}
            Chat con Soporte
        {% else %}
            Chat sobre {{ herramienta.nombre }}
        {% endif %}
    </h1>

    <!-- Información de ubicación de los usuarios -->
    {% if not es_soporte %}
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ubicación de los usuarios</h2>
        <p class="text-gray-600"><strong>Arrendatario:</strong> {{ chat.arrendatario.usuario.get_full_name }} - {{ chat.arrendatario.direccion }}</p>
        <p class="text-gray-600"><strong>Arrendador:</strong> {{ chat.arrendador.usuario.get_full_name }} - {{ chat.arrendador.direccion }}</p>
    </div>
    {% endif %}

    <!-- Botón para solicitar Uber -->
    {% if not es_soporte and request.user == chat.arrendatario.usuario %}
    <div class="flex items-center justify-end mt-4">
        <button type="button" class="p-2" onclick="solicitarUberConNominatim()">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-600 hover:text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l1.38-4.607A2 2 0 0016.5 7h-9a2 2 0 00-1.933 1.524L3 13zm0 0v6a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-6M5 21h.01M19 21h.01" />
            </svg>
            <span class="ml-2 text-gray-600 hover:text-green-500">Solicitar Uber</span>
        </button>
    </div>
    {% endif %}
</div>

<script>
    async function obtenerCoordenadasEstructuradas(direccion) {
        const { street, postalcode, city, state, country } = direccion;
        const url = `https://nominatim.openstreetmap.org/search?format=json&street=${encodeURIComponent(street)}&postalcode=${postalcode}&city=${encodeURIComponent(city)}&state=${encodeURIComponent(state)}&country=${encodeURIComponent(country)}`;

        console.log("URL estructurada:", url);

        try {
            const response = await fetch(url, {
                headers: { 'User-Agent': 'ChatGPT-Django-App' }, // Identificador requerido por Nominatim
            });
            const data = await response.json();
            if (data.length > 0) {
                console.log("Coordenadas obtenidas:", data[0]);
                return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            } else {
                console.warn("No se encontraron coordenadas para la dirección:", direccion);
                return null;
            }
        } catch (error) {
            console.error("Error al obtener coordenadas:", error);
            return null;
        }
    }

    async function solicitarUberConNominatim() {
        // Direcciones estructuradas del arrendatario y arrendador
        const direccionOrigen = {
            street: "Salvarcar",
            postalcode: "32676",
            city: "Juarez",
            state: "Chihuahua",
            country: "Mexico"
        };
        const direccionDestino = {
            street: "Palacio de mitla",
            postalcode: "32573",
            city: "Juarez",
            state: "Chihuahua",
            country: "Mexico"
        };

        console.log("Iniciando solicitud de Uber con Nominatim...");
        console.log("Dirección de origen:", direccionOrigen);
        console.log("Dirección de destino:", direccionDestino);

        try {
            // Obtener coordenadas para origen y destino
            const origenCoords = await obtenerCoordenadasEstructuradas(direccionOrigen);
            const destinoCoords = await obtenerCoordenadasEstructuradas(direccionDestino);

            if (origenCoords && destinoCoords) {
                const uberURL = `https://m.uber.com/ul/?action=setPickup&pickup[latitude]=${origenCoords.lat}&pickup[longitude]=${origenCoords.lng}&dropoff[latitude]=${destinoCoords.lat}&dropoff[longitude]=${destinoCoords.lng}`;
                console.log("URL de Uber generada:", uberURL);
                window.open(uberURL, '_blank');
            } else {
                alert("No se pudieron obtener las coordenadas para alguna de las direcciones.");
            }
        } catch (error) {
            console.error("Error al solicitar Uber:", error);
        }
    }
</script>
{% endblock %}
